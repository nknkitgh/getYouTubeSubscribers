// URL、チャンネル登録数、チャンネル名、チャンネルアイコン(URL)、動画本数、概要を取得
// URLから正しいチャンネルが取得できていないものがあった

const SPREADSHEET_ID = '1x5pntmQB1cgonogxk-NTjC0mQDL0O_ezKD092RqlH_w';
const SHEET_NAME = 'Sheet1';
const API_KEY = 'AIzaSyApRuGgWYCWiKJ-gwK1BVXFltmnbWlL5DI';

function getYouTubeChannelDetails() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const range = sheet.getRange('A2:A' + sheet.getLastRow());
  const urls = range.getValues();
  const channelDetails = [];

  for (const [url] of urls) {
    if (url) {
      const channelId = extractChannelId(url);
      Logger.log('Channel ID: ' + channelId);
      if (channelId) {
        const channelInfo = getChannelInfo(channelId);
        Logger.log('Channel Info: ' + JSON.stringify(channelInfo));
        if (channelInfo) {
          channelDetails.push([
            channelInfo.subscribers,
            channelInfo.channelName,
            channelInfo.channelIcon,
            channelInfo.videoCount,
            channelInfo.description
          ]);
        } else {
          channelDetails.push(['チャンネル情報が見つかりません', '', '', '', '']);
        }
      } else {
        channelDetails.push(['チャンネルIDが無効です', '', '', '', '']);
      }
    } else {
      channelDetails.push(['URLが無効です', '', '', '', '']);
    }
  }

  const resultRange = sheet.getRange(2, 2, channelDetails.length, 5);
  resultRange.setValues(channelDetails);
}

function extractChannelId(url) {
  const regex = /https:\/\/www\.youtube\.com\/@([a-zA-Z0-9_-]+)/;
  const match = url.match(regex);
  if (match) {
    const accountName = match[1];
    const options = {
      method: 'GET',
      muteHttpExceptions: true
    };
    const response = UrlFetchApp.fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${accountName}&key=${API_KEY}`, options);
    Logger.log('Extract Channel ID Response: ' + response.getContentText());
    const data = JSON.parse(response.getContentText());
    return data.items && data.items.length > 0 ? data.items[0].id.channelId : null;
  }
  return null;
}

function getChannelInfo(channelId) {
  const options = {
    method: 'GET',
    muteHttpExceptions: true
  };
  const response = UrlFetchApp.fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`, options);
  Logger.log('getChannelInfo Response: ' + response.getContentText());
  const data = JSON.parse(response.getContentText());
  
  if (data.items && data.items.length > 0) {
    const channel = data.items[0];
    return {
      subscribers: channel.statistics.subscriberCount,
      channelName: channel.snippet.title,
      channelIcon: channel.snippet.thumbnails.default.url,
      videoCount: channel.statistics.videoCount,
      description: channel.snippet.description
    };
  }
  return null;
}
