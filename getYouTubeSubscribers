// URL、チャンネル登録数、チャンネル名、チャンネルアイコン(URL)、動画本数、概要を取得
// URLから正しいチャンネルが取得できていないものがあった

const SPREADSHEET_ID = '1x5pntmQB1cgonogxk-NTjC0mQDL0O_ezKD092RqlH_w';
const SHEET_NAME = 'Sheet1';
const API_KEY = 'AIzaSyApRuGgWYCWiKJ-gwK1BVXFltmnbWlL5DI';

function getYouTubeChannelDetails() {
  const sheet = SpreadsheetApp.openById(SPREADSHEET_ID).getSheetByName(SHEET_NAME);
  const range = sheet.getRange('A2:A' + sheet.getLastRow());
  const urls = range.getValues();
  const channelDetails = [];

  for (const [url] of urls) {
    if (url) {
      const accountName = extractAccountName(url);
      Logger.log('Account Name: ' + accountName);
      if (accountName) {
        const channelInfo = getChannelInfo(accountName);
        Logger.log('Channel Info: ' + JSON.stringify(channelInfo));
        if (channelInfo) {
          channelDetails.push([
            channelInfo.subscribers,
            channelInfo.channelName,
            channelInfo.channelIcon,
            channelInfo.videoCount,
            channelInfo.description
          ]);
        } else {
          channelDetails.push(['チャンネルIDが見つかりません', '', '', '', '']);
        }
      } else {
        channelDetails.push(['アカウント名が無効です', '', '', '', '']);
      }
    } else {
      channelDetails.push(['URLが無効です', '', '', '', '']);
    }
  }

  const resultRange = sheet.getRange(2, 2, channelDetails.length, 5);
  resultRange.setValues(channelDetails);
}

function extractAccountName(url) {
  const regex = /https:\/\/www\.youtube\.com\/@([a-zA-Z0-9_-]+)/;
  const match = url.match(regex);
  return match ? match[1] : null;
}

function getChannelInfo(accountName) {
  const options = {
    method: 'GET',
    muteHttpExceptions: true
  };
  const searchResponse = UrlFetchApp.fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&type=channel&q=${accountName}&key=${API_KEY}`, options);
  Logger.log('getChannelInfo Response: ' + searchResponse.getContentText());
  const searchData = JSON.parse(searchResponse.getContentText());
  
  if (searchData.items && searchData.items.length > 0) {
    const channelId = searchData.items[0].id.channelId;
    const channelResponse = UrlFetchApp.fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,statistics&id=${channelId}&key=${API_KEY}`, options);
    Logger.log('Channel Data Response: ' + channelResponse.getContentText());
    const channelData = JSON.parse(channelResponse.getContentText());
    
    if (channelData.items && channelData.items.length > 0) {
      const channel = channelData.items[0];
      return {
        subscribers: channel.statistics.subscriberCount,
        channelName: channel.snippet.title,
        channelIcon: channel.snippet.thumbnails.default.url,
        videoCount: channel.statistics.videoCount,
        description: channel.snippet.description
      };
    }
  }
  return null;
}
